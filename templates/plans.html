<!DOCTYPE html>
<html lang="en">

{% include 'head.html' %}


<!-- CSS for Tabs -->
<style>
    .tab-button {
        transition: all 0.3s ease;
    }

    .tab-button.active {
        background-color: #10b981;
        /* Green to match text-green-600 */
        color: white;
    }

    .tab-button:hover {
        background-color: #10b981;
        /* Light green on hover */
    }

    .tab-content {
        display: block;
    }

    .tab-content.hidden {
        display: none;
    }
</style>

<body>

    <div class="modal fade" id="payModal" tabindex="-1" role="dialog" aria-labelledby="payModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content" id="payModalContent">
            </div>
        </div>
    </div>

    <div class="modal fade" id="donateModal" tabindex="-1" role="dialog" aria-labelledby="donateModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <h5 class="text-center">üôè Support Us üôè</h5>
                    <button type="button" class="close" data-dismiss="modal">√ó</button>
                </div>
                <div class="modal-body">
                    <h6 class="text-black">
                        üöÄ Donate today and help us keep <strong>TIPSPESA Project</strong> Free Forever üöÄ
                    </h6><br />
                    <div class="form-group row">
                        <label for="amount" class="form-label">Amount to Donate in USD: <strong
                                id="amount-value">1üí≤</strong></label>
                        <div class="input-group">
                            <input type="range" class="form-range" min="1" max="10" name="amount" id="amount" value="2">
                        </div>
                    </div>
                    <div class="form-group text-right">
                        <button type="button" class="btn btn-success btn-flat pull-right" data-dismiss="modal"
                            onclick="InitiateTransaction()">Donate Now</button>

                    </div><br />

                    <div class="row text-left">
                        <h6 class="text-black">Why your support matters:</h6><br /><br />
                        <blockquote class="blockquote">
                            <footer class="blockquote-footer">üñ• Cover server costs to keep TIPSPESA running smoothly
                                for everyone.</footer>
                            <footer class="blockquote-footer">üõ† Fund ongoing development and new features at no cost to
                                users.</footer>
                            <footer class="blockquote-footer">üåç Ensure free access for underserved communities
                                worldwide.</footer>
                            <footer class="blockquote-footer">üíì Help us sustain this open project‚Äîevery dollar makes a
                                difference!</footer>
                        </blockquote>
                    </div>
                </div>

                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const slider = document.getElementById('amount');
                        const valueDisplay = document.getElementById('amount-value');

                        function updateValue() {
                            valueDisplay.textContent = 'üí≤' + slider.value;
                        }

                        slider.addEventListener('input', updateValue);
                        updateValue(); // Initialize with default value
                    });
                </script>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form method="POST" class="form-horizontal">
                    <div class="modal-header text-center">
                        <h5 class="text-center"><b id="plan"></b> Premium Tips Subscription</h5>
                        <button type="button" class="close" data-dismiss="modal">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group row">
                            <label class="col-4 text-end control-label col-form-label">Subscription Period:</label>
                            <div class="col-8">
                                <div class="form-check form-check">
                                    <input class="form-check-input" type="radio" name="amount" id="daily" value="30"
                                        required>
                                    <label class="form-check-label" for="daily">Daily @KSh. 30</label>
                                </div>
                                <div class="form-check form-check">
                                    <input class="form-check-input" type="radio" name="amount" id="weekly" value="150"
                                        required>
                                    <label class="form-check-label" for="weekly">Weekly @KSh. 150</label>
                                </div>
                                <div class="form-check form-check">
                                    <input class="form-check-input" type="radio" name="amount" id="monthly" value="500"
                                        required>
                                    <label class="form-check-label" for="monthly">Monthly @KSh. 500</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-4 text-end control-label col-form-label">Your Email:</label>
                            <div class="col-8">
                                <input required="required" type="email" name="phone" id="phone"
                                    class="form-control input-sm" placeholder="user@gmail.com">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                        <button type="submit" id="action" name="action" value="login"
                            class="btn btn-success">Subscribe</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <div class="modal fade" id="resultModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form method="POST" class="form-horizontal">
                    <input type="hidden" name="match_id" id="match_id">
                    <div class="modal-header text-center">
                        <h5 class="text-center">Update Results</h5>
                        <button type="button" class="close" data-dismiss="modal">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group row">
                            <label class="col-7 text-end control-label col-form-label" id="home_team"
                                for="home_team_goals"></label>
                            <div class="col-5">
                                <input required="required" type="number" name="home_team_goals" id="home_team_goals"
                                    class="form-control input-sm" placeholder="Home Team Goals">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-7 text-end control-label col-form-label" id="away_team"
                                for="away_team_goals"></label>
                            <div class="col-5">
                                <input required="required" type="number" name="away_team_goals" id="away_team_goals"
                                    class="form-control input-sm" placeholder="Away Team Goals">
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-7 text-end control-label col-form-label" for="status">Status</label>
                            <div class="col-5">
                                <input required="required" type="text" name="status" id="status"
                                    class="form-control input-sm" placeholder="Status (WON, LOST, PENDING)">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                        <button type="submit" id="action" name="action" value="update_results"
                            class="btn btn-success">Update Results</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Header -->
    <header class="sticky top-0 bg-gray-900 shadow-md z-10 text-white p-2">
        <div class="container mx-auto flex">
            <a href="https://tipspesa.vercel.app/" class="flex">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="h-12">
            </a>
            <a class="btn btn-xs btn-flat btn-success flex" href="#" data-toggle="modal" data-target="#donateModal">Support Us</a>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content bg-white">

        <div class="whatsapp-float" style="bottom: 75px;">
            <a href="https://wa.me/+254759697757" class="text-white text-xs font-bold" target="_blank"
                title="Chat with us on WhatsApp">
                <img src="{{ url_for('static', filename='whatsapp.png') }}" alt="WhatsApp" width="36px">
            </a>
        </div>

        <div class="whatsapp-float">
            <a href="#" data-toggle="modal" data-target="#donateModal">
                <img src="{{ url_for('static', filename='donate.png') }}" alt="Support" width="72px">
            </a>
        </div>

        <div>
            <section class="p-2">
                <div class="bg-white text-white p-4 mb-7 rounded-lg shadow-md"
                    style="background-image: url({{ url_for('static', filename='Subbackground.png') }}); background-size: cover;">
                    <div class="flex justify-between items-center">
                        <span
                            class="bg-{{ plan.color }}-100 text-{{ plan.color }}-800 text-xs font-bold px-2 py-1 rounded-full">Today
                            Predictions - {{ plan.matches |
                            length }} matches
                        </span>
                        <!-- <a href="${window.location.href}"
   class="bg-blue-100 text-blue-800 text-xs font-bold rounded-full px-2 py-1 inline-flex items-center gap-2">
    <i class="fas fa-refresh"></i> Refresh Page
                        </a> -->
                        <div class="text-yellow-400">
                            {% for i in range(plan.stars) %}
                            <i class="fas fa-star"></i>
                            {% endfor %}
                            {% for i in range(5-plan.stars) %}
                            <i class="fas fa-star text-white"></i>
                            {% endfor %}
                        </div>
                        
                    </div>
                    <br />
                    <!-- Tab Navigation -->
                    <div class="tab-nav flex justify-center mb-4">
                        {% for slip in slips %}
                        <a href="#{{ slip.id }}"
                            class="slip-tab-button tab-button px-2 py-2 mx-1 font-semibold text-gray-700 text-xs bg-gray-200 rounded-t-lg"
                            data-tab="slip_{{ slip.id }}">Slip {{ slip.id }}
                        </a>
                        {% endfor %}
                    </div>
                    {% for slip in slips %}
                    <div id="slip_{{ slip.id }}" class="slip-tab-content tab-content">
                        <table class="results-table">
                            {% if slip.matches %}
                            <tr>
                                <th>Time</th>
                                <th>Fixture</th>
                                <th>Tip</th>
                                <th>Odd</th>
                            </tr>
                            {% set ns = namespace(total_odds=1, posted=0) %}
                            {% for match in slip.matches %}
                            {% set ns.total_odds = ns.total_odds * match.odd %}
                            <tr>
                                <td>
                                    {{ 'Yesterday' if match.kickoff.strftime('%A')==yesterday else 'Today' if
                                    match.kickoff.strftime('%A')==today else 'Tomorrow' if
                                    match.kickoff.strftime('%A')==tomorrow else match.kickoff.strftime('%A') }} <br />
                                    {{ match.kickoff.strftime('%H:%M') }}
                                </td>
                                <td>
                                    {{ match.home_team }} vs {{ match.away_team }} <br />
                                    {{ '[' ~ match.league ~ ']' if match.league else '' }}
                                </td>
                                {% if true or current_user.active or slip.id==1 or current_time.strftime('%Y-%m-%d
                                %H:%M:%S') > match.kickoff.strftime('%Y-%m-%d %H:%M:%S') %}
                                {% set ns.posted = ns.posted + 1 %}
                                <td>
                                    <small>{{ match.prediction | capitalize }}</small> <br />
                                    {{ match.bet_pick | upper }}
                                </td>
                                {% elif loop.index==ns.posted+1 %}
                                <td class="text-center" rowspan="{{ (slip.matches | length)-ns.posted }}"
                                    style="border-left: 1px solid; border-right: 1px solid;">
                                    <a href="#" data-toggle="modal" data-target="#loginModal">
                                        <button
                                            class="bg-yellow-100 text-yellow-800 text-md font-bold px-2 py-1 rounded-lg mt-2">
                                            Click Here to UNLOCK All Tips in All Betslips now<br />
                                            @ KSh. 30 <br />
                                            Once Paid, All Tips in All Betslips will be displayed.
                                        </button>
                                    </a>
                                </td>
                                {% endif %}
                                <td>
                                    <small {% if current_user.phone=='admin@tipspesa.com' %}
                                        onclick="editMatch('{{ match.match_id }}', '{{ match.home_team }}', '{{ match.away_team }}', '{{ match.home_results }}', '{{ match.away_results }}', '{{ match.status }}')"
                                        {% endif %}>
                                        {{ match.odd ~ ' (' ~ match.overall_prob ~ '%)' }} <br />
                                        {{ (match.home_results ~ '-' ~ match.away_results) if match.home_results is not
                                        none or match.away_results is not none else '' }}
                                        {% if match.status == 'WON' %}
                                        <span class="fa fa-check-circle" style="color: green; font-size: 16px;"></span>
                                        {% elif match.status == 'LOST' %}
                                        <span class="fa fa-minus-circle" style="color: grey; font-size: 16px;"></span>
                                        {% else %}
                                        {{ '[' ~ match.status ~ ']' if match.status else '' }}
                                        {% endif %}
                                    </small>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if true or current_user.active or slip.id==1 %}
                            <tr>
                                {% if slip.betika_share_code %}
                                <td id="betika_share" class="text-sm" colspan="4">
                                    <small>
                                        Betika Share Code </br>
                                        <span
                                            class="bg-{{ plan.color }}-100 text-{{ plan.color }}-800 text-xs font-bold px-2 py-1 rounded-full"
                                            onclick="copyToClipboard('{{ slip.betika_share_code }}')">
                                            {{ slip.betika_share_code }}
                                        </span><br />
                                        <i>Tap to Copy</i>
                                    </small>
                                </td>
                                {% endif %}
                            </tr>
                            {% endif %}
                            <tr>
                                <th colspan="3">BetSlip {{ slip.id }} Total Odds</th>
                                <th>{{ ns.total_odds | round(2) }}</th>
                            </tr>
                            {% else %}
                            <th colspan="4">
                                Sorry, Our A.I could not find viable matches for Slip {{
                                slip.id }} today. Kindly check back Later!
                            </th>
                            {% endif %}
                        </table>
                    </div>
                    {% endfor %}
                </div>
            </section>

            <!-- Dynamic Tabs for Matches in plans.history -->
            <section class="p-2">
                <div class="bg-white p-2 rounded-lg shadow-md">
                    <!-- Tab Navigation -->
                    <div class="tab-nav flex justify-center mb-4">
                        {% for history in plan.history %}
                        <button
                            class="history-tab-button tab-button px-3 py-2 mx-1 font-semibold text-gray-700 text-xs bg-gray-200 rounded-t-lg {% if loop.last %}active{% endif %}"
                            data-tab="{{ history.day | lower }}">{{ history.day }}</button>
                        {% endfor %}
                    </div>

                    <!-- Tab Content -->
                    {% for history in plan.history %}
                    <div id="{{ history.day | lower }}"
                        class="history-tab-content tab-content {% if not loop.last %}hidden{% endif %}">
                        {% if history.matches | length > 0 %}
                        {% set ns = namespace(won=0) %}                            
                        {% for match in history.matches %}
                        {% set ns.won = ns.won + (0 if match.status=='LOST' else 1) %}                      
                        {% endfor %}
                        {% set win_perc = (100*ns.won/(history.matches | length)) %}
                        <div class="tab-nav flex justify-center mb-4">
                            <div id="circles-{{ loop.index }}"></div>
                        </div>                        
                        <div class="tab-nav flex justify-center mb-4">
                            <sub><strong>{{ ns.won }}/{{ history.matches | length }} Predicted Matches Won</strong></sub>
                        </div>                        
                        <script>
                            Circles.create({
                                id:                 'circles-{{ loop.index }}',
                                radius:             64,
                                value:              '{{ win_perc }}',
                                maxValue:           100,
                                width:              7,
                                text:               '{{ win_perc | int }}%',
                                colors:             ['white', '{{ "green" if win_perc >= 85 else "orange" if win_perc >= 70 else "yellow" if win_perc >= 50 else "red" }}'],                                
                                duration:            400,
                                wrpClass:            'circles-wrp',
                                textClass:           'circles-text',
                                valueStrokeClass:    'circles-valueStroke',
                                maxValueStrokeClass: 'circles-maxValueStroke',
                                styleWrapper:        true,
                                styleText:           true
                            })
                        </script>
                        <table class="results-table w-full border-collapse">
                            <tr>
                                <th>Fixture</th>
                                <th>Tip</th>
                                <th>Result</th>
                            </tr>
                            {% for match in history.matches %}
                            <tr>
                                <td>{{ match.home_team }} vs {{ match.away_team }}</td>
                                <td>
                                    <small>{{ match.prediction | capitalize }}</small> <br />
                                    {{ match.bet_pick | upper }}
                                </td>

                                <td>
                                    <small {% if current_user.phone=='admin@tipspesa.com' %}
                                        onclick="editMatch('{{ match.match_id }}', '{{ match.home_team }}', '{{ match.away_team }}', '{{ match.home_results }}', '{{ match.away_results }}', '{{ match.status }}')"
                                        {% endif %}>
                                        {{ match.odd ~ ' (' ~ match.overall_prob ~ '%)' }} <br />
                                        {{ (match.home_results ~ '-' ~ match.away_results) if match.home_results is not
                                        none or match.away_results is not none else '' }}
                                        {% if match.status == 'WON' %}
                                        <span class="fa fa-check-circle" style="color: green; font-size: 16px;"></span>
                                        {% elif match.status == 'LOST' %}
                                        <span class="fa fa-minus-circle" style="color: grey; font-size: 16px;"></span>
                                        {% else %}
                                        {{ '[' ~ match.status ~ ']' if match.status else '' }}
                                        {% endif %}
                                    </small>
                                </td>
                            </tr>
                            {% endfor %}
                        </table>
                        {% else %}
                        <p class="text-center text-gray-500">No {{ history.day }} tips available.</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </section>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <script src="{{ url_for('static', filename='plugin.js') }}"></script>

    <!--  include 'footer.html'  -->

    <script>
        function InitiateTransaction() {
            amount = $("#amount").val()

            fetch("{{ url_for('index') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'donate',
                    amount: amount ? amount : 1
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        $("#payModalContent").html(`
                            <iframe 
                                src=${data.authorization_url}
                                frameborder="0" 
                                width="100%" 
                                height="600px">
                            </iframe>
                        `)
                    }
                })
                .catch(error => {
                    console.error('Error fetching checkout URL:', error);
                    $("#payModalContent").html('Payment initiation failed. Please try again.');
                })
                .finally(data => {
                    // Show the modal
                    $('#payModal').modal('show');
                });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function () {
                console.log('Betika share code copied to clipboard! \nPaste the Code at Betika App `Load Betslip` to import');
            }, function (err) {
                console.error('Could not copy text: ', err);
            });
        }

        function editMatch(id, home_team, away_team, home_team_goals, away_team_goals, status) {
            // Set the values in the modal
            $('#match_id').val(id)
            $('#home_team').html(home_team)
            $('#away_team').html(away_team)
            $('#home_team_goals').val(home_team_goals)
            $('#away_team_goals').val(away_team_goals)
            $('#status').val(status != 'None' ? status : '');

            // Show the modal
            $('#resultModal').modal('show');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Handle Slip Tabs (with hash support and special logic)
            const slipButtons = document.querySelectorAll('.slip-tab-button');
            const slipContents = document.querySelectorAll('.slip-tab-content');

            // Helper function for slip tabs
            function activateSlipTab(targetButton = null, targetTabId = null) {
                // Remove active class from all slip buttons
                slipButtons.forEach(btn => btn.classList.remove('active'));
                // Hide all slip contents
                slipContents.forEach(content => content.classList.add('hidden'));

                if (targetButton) {
                    // Add active class to target button
                    targetButton.classList.add('active');
                    // Show the selected tab content
                    const tabId = targetButton.getAttribute('data-tab');
                    const targetContent = document.getElementById(tabId);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                } else if (targetTabId) {
                    // Alternative: activate by tabId directly (e.g., for hash matching)
                    const targetContent = document.getElementById(targetTabId);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                    // Find and activate the button for this tabId
                    const targetButton = Array.from(slipButtons).find(btn => btn.getAttribute('data-tab') === targetTabId);
                    if (targetButton) {
                        targetButton.classList.add('active');
                    }
                }
            }

            // Initial activation based on URL hash for slips (e.g., #3 activates Slip 3 tab)
            function handleSlipHashActivation() {
                const hash = window.location.hash.substring(1);  // e.g., "3" from "#3"
                if (hash) {
                    // Find button with matching href="#hash"
                    const targetButton = Array.from(slipButtons).find(btn => btn.getAttribute('href') === `#${hash}`);
                    if (targetButton) {
                        const tabId = targetButton.getAttribute('data-tab');  // e.g., "slip_3"
                        activateSlipTab(targetButton, tabId);
                        // Optional: Scroll to the content
                        const targetContent = document.getElementById(tabId);
                        // if (targetContent) {
                        //     targetContent.scrollIntoView({ behavior: 'smooth' });
                        // }
                        return;  // Activated, skip default
                    }
                }
                // Default: Activate first slip tab
                activateSlipTab(slipButtons[0]);
            }

            // Handle initial load for slips
            handleSlipHashActivation();

            // Listen for hash changes (e.g., browser back/forward or external links)
            window.addEventListener('hashchange', () => {
                handleSlipHashActivation();
            });

            // Click handler for slip buttons
            slipButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    activateSlipTab(button, tabId);

                    // Your special logic for slips
                    const last = slipButtons.length - 1;
                    slipButtons[last].classList.add('active');
                    slipContents[last].classList.remove('hidden');
                    if (typeof median !== 'undefined' && median.admob) {
                        median.admob.showInterstitialIfReady();
                    }
                });
            });

            // Handle History Tabs (simple switching, no hash or special logic)
            const historyButtons = document.querySelectorAll('.history-tab-button');
            const historyContents = document.querySelectorAll('.history-tab-content');

            historyButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all history buttons
                    historyButtons.forEach(btn => btn.classList.remove('active'));
                    // Add active class to clicked button
                    button.classList.add('active');

                    // Hide all history tab contents
                    historyContents.forEach(content => content.classList.add('hidden'));
                    // Show the selected tab content
                    const tabId = button.getAttribute('data-tab');
                    const targetContent = document.getElementById(tabId);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });

            //show interstitial ad 20 seconds after page load
            setTimeout(() => {
                if (typeof median !== 'undefined' && median.admob) {
                    median.admob.showInterstitialIfReady();
                }
            }, 20000);

            //show interstitial ad 120 seconds after page load
            setTimeout(() => {
                if (typeof median !== 'undefined' && median.admob) {
                    median.admob.showInterstitialIfReady();
                }
            }, 120000);

        });

    </script>
</body>


</html>





